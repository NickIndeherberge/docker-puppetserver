#!/bin/bash -e
#
# S2I run script for the 'puppetserver' image.


if [ `id -u` -ge 10000 ]; then
    grep -v puppet /etc/passwd > /tmp/passwd
    echo "puppet:x:`id -u`:`id -g`:puppetserver daemon:/opt/puppetlabs/server/data/puppetserver:/sbin/nologin" >> /tmp/passwd
    cat /tmp/passwd > /etc/passwd
    rm /tmp/passwd
fi

cp /tmp/ca-certs/* /etc/puppetlabs/ssl/ca/
touch /etc/puppetlabs/ssl/ca/inventory.txt
echo "001" > /etc/puppetlabs/ssl/ca/serial
exec /usr/local/bin/start-puppet-server
