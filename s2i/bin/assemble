#!/bin/bash -e
#
# S2I assemble script for the 'puppetserver' image.

# If the 'puppetserver' assemble script is executed with the '-h' flag, print the usage.
if [[ "$1" == "-h" ]]; then
	exec /usr/libexec/s2i/usage
fi


# Copy the Puppet code from the cloned repository towards the puppet code dir.

echo "---> Copying puppet code to puppetserver code-dir"
rm -rf /tmp/src/.git

echo "---> Symlinking code to all environments"

ln -s /tmp/src/ /etc/puppetlabs/code/environments/dev
ln -s /tmp/src/ /etc/puppetlabs/code/environments/acc
ln -s /tmp/src/ /etc/puppetlabs/code/environments/prd
ln -s /tmp/src/ /etc/puppetlabs/code/environments/drp

ln -s /etc/puppetlabs/code/environments/production/manifests/site.pp /etc/puppetlabs/code/environments/dev/manifests/site.pp
ln -s /etc/puppetlabs/code/environments/production/manifests/site.pp /etc/puppetlabs/code/environments/acc/manifests/site.pp
ln -s /etc/puppetlabs/code/environments/production/manifests/site.pp /etc/puppetlabs/code/environments/prd/manifests/site.pp
ln -s /etc/puppetlabs/code/environments/production/manifests/site.pp /etc/puppetlabs/code/environments/drp/manifests/site.pp
