apiVersion: v1
kind: List
metadata:
  name: puppetserver-dev
items:
  ## DEPLOYMENTCONFIG ##
  - apiVersion: v1
    kind: DeploymentConfig
    metadata:
      labels:
        app: puppetserver-code
        env: dev
      name: puppetserver-code-dev
    spec:
      replicas: 1
      selector:
        app: puppetserver-code-dev
        deploymentconfig: puppetserver-code-dev
      template:
        metadata:
          labels:
            app: puppetserver-code-dev
            deploymentconfig: puppetserver-code-dev
            env: dev
        spec:
        containers:
        - image: 'puppetserver-code-dev:latest'
          imagePullPolicy: Always
          name: puppetserver-code-dev
          ports:
          - containerPort: 8140
            protocol: TCP
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: /thycotic
            name: thycotic
          - mountPath: /certs
            name: cert-volume
            readOnly: true
          - mountPath: /etc/puppet/
            name: puppet
          - mountPath: /opt/puppetlabs/server/data/puppetserver/yaml/facts
            name: facts
          - mountPath: /opt/puppetlabs/server/data/puppetserver/yaml/foreman
            name: foreman
        - command:
          - /bin/sh
          - -c
          - sleep 30 && while true; do echo 'Pushing facts to foreman' && date && /opt/puppetlabs/bin/puppetserver
            ruby /usr/local/bin/external_node_v2.rb --push-facts-parallel && sleep 1800;
            done
          image: 'puppetserver-code-dev:latest'
          imagePullPolicy: Always
          name: facts-to-foreman
          resources: {}
          terminationMessagePath: /dev/termination-log
          terminationMessagePolicy: File
          volumeMounts:
          - mountPath: /etc/puppet/
            name: puppet
          - mountPath: /opt/puppetlabs/server/data/puppetserver/yaml/facts
            name: facts
          - mountPath: /opt/puppetlabs/server/data/puppetserver/yaml/foreman
            name: foreman
          - mountPath: /certs
            name: cert-volume
        dnsPolicy: ClusterFirst
        restartPolicy: Always
        schedulerName: default-scheduler
        securityContext: {}
        terminationGracePeriodSeconds: 30
        volumes:
        - emptyDir: {}
          name: thycotic
        - emptyDir: {}
          name: facts
        - emptyDir: {}
          name: foreman
        - name: cert-volume
          secret:
            defaultMode: 420
            secretName: puppetmaster-certificates
        - configMap:
            defaultMode: 420
            items:
            - key: thycotic.conf
              path: thycotic.conf
            - key: foreman
              path: foreman.yaml
            - key: puppet.conf
              path: puppet.conf
            name: puppetserver-configuration
          name: puppet
      triggers:
        - imageChangeParams:
            automatic: true
            containerNames:
              - puppetserver-code-dev
            from:
              kind: ImageStreamTag
              name: 'puppetserver-code-dev:latest'
              namespace: ci00053160-puppetserver
          type: ImageChange
        - type: ConfigChange
  ## SERVICE ##
  - apiVersion: v1
    kind: Service
    metadata:
      labels:
        app: puppetserver-code-dev
      name: puppetserver-code-dev
    spec:
      ports:
        - name: 443-tcp
          port: 443
          protocol: TCP
          targetPort: 8140
      selector:
        deploymentconfig: puppetserver-code-dev
  ## ROUTE ##
  - apiVersion: v1
    kind: Route
    metadata:
      labels:
        app: puppetserver-code-dev
      name: puppetserver-code-dev
    spec:
      host: dev.openshift-puppetmaster.cegeka.be
      port:
        targetPort: 443-tcp
      tls:
        termination: passthrough
      to:
        kind: Service
        name: puppetserver-code-dev

